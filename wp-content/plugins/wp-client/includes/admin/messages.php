<?php
global $wpdb; $count_sent = 0; if ( isset($_REQUEST['_wp_http_referer']) ) { $redirect = remove_query_arg(array('_wp_http_referer' ), wp_unslash( $_REQUEST['_wp_http_referer'] ) ); } else { $redirect = get_admin_url(). 'admin.php?page=wpclients_content&tab=private_messages'; } if ( isset( $_GET['action'] ) ) { switch ( $_GET['action'] ) { case 'add_message': if ( isset( $_POST['private_message'] ) && '' != $_POST['private_message'] ) { $manager_id = get_current_user_id(); $sent_from = get_current_user_id(); if ( isset( $_GET['user_id'] ) ) $user_id = $_GET['user_id']; if ( isset( $_POST['from_messages_page'] ) && 1 == $_POST['from_messages_page'] && isset($_POST['wpc_clients']) && isset($_POST['wpc_circles']) ) { $sent_to_row = $_POST['wpc_clients']; if( 'all' == $sent_to_row ) { if( current_user_can( 'wpc_manager' ) && !current_user_can( 'administrator' ) ) { $sent_to = $this->cc_get_assign_data_by_object( 'manager', $manager_id, 'client' ); $manager_groups = $this->cc_get_assign_data_by_object( 'manager', $manager_id, 'circle' ); foreach ( $manager_groups as $group_id ) { $add_client = $this->cc_get_group_clients_id( $group_id ); $sent_to = array_merge( $sent_to, $add_client ); } $sent_to = array_unique( $sent_to ); } else $sent_to = $this->acc_get_client_ids(); } elseif ( '' == $sent_to_row ) { $sent_to = array(); } else { $sent_to = explode( ',', $sent_to_row ); } $sent_to_circle = $_POST['wpc_circles']; if( 'all' == $sent_to_circle ) { if( current_user_can( 'wpc_manager' ) && !current_user_can( 'administrator' ) ) $add_sent_to = $this->cc_get_assign_data_by_object( 'manager', $manager_id, 'circle' ); else $add_sent_to = $this->cc_get_group_ids(); } elseif ( '' == $sent_to_circle ) { $add_sent_to = array(); } else { $add_sent_to = explode( ',', $sent_to_circle ); } if ( 0 < count($add_sent_to) ) { $add_client_circles = array(); foreach ( $add_sent_to as $id_group ) { $add_client = $this->cc_get_group_clients_id( $id_group ); $add_client_circles = array_merge($add_client_circles, $add_client ); } $add_sent_to = array_unique($add_client_circles); } $sent_to = array_merge( $add_sent_to, $sent_to ); $sent_to = array_unique( $sent_to ); } elseif ( $_GET['from_id'] == $sent_from ) { $sent_to = $_POST['sent_client_id']; } else { $sent_to = $_GET['from_id']; } $count_sent = count($sent_to); if ( 0 == $count_sent ) { do_action( 'wp_client_redirect', get_admin_url(). 'admin.php?page=wpclients_content&tab=private_messages&msg=error' ); } else { if (is_array( $sent_to ) ) { foreach( $sent_to as $val ) { $wpdb->query( $wpdb->prepare( "INSERT INTO {$wpdb->prefix}wpc_client_comments SET user_id = %d, page_id = 0, time=%d, comment='%s', sent_from=%d, sent_to=%d, new_flag=2" , $val , time() , $_POST['private_message'] , $sent_from , $val ) ); } } else { $wpdb->query( $wpdb->prepare( "INSERT INTO {$wpdb->prefix}wpc_client_comments SET user_id = %d, page_id = 0, time=%d, comment='%s', sent_from=%d, sent_to=%d, new_flag=2" , $user_id , time() , $_POST['private_message'] , $sent_from , $sent_to ) ); } $wpc_general = $this->cc_get_settings( 'general' ); if ( isset( $_POST['from_messages_page'] ) && 1 == $_POST['from_messages_page'] && is_array( $sent_to ) ) { foreach( $sent_to as $val ) { $send_to_user = get_userdata( $val ); if ( !$send_to_user ) { continue; } $send_to_email = $send_to_user->get( 'user_email' ); if ( 0 != $sent_from ) { $sent_from_user = get_userdata( $sent_from ); if ( $sent_from_user ) { $username = $sent_from_user->get( 'display_name' ); } else { $username = ''; } } else { $username = 'Administrator'; } $args = array( 'client_id' => $val, 'user_name' => $username, 'message' => nl2br( htmlspecialchars( stripslashes( $_POST['private_message'] ) ) ) ); $this->cc_mail( 'notify_client_about_message', $send_to_email, $args, 'notify_client_about_message' ); } } else { $send_to_user = get_userdata( $sent_to ); if ( $send_to_user ) { $send_to_email = $send_to_user->get( 'user_email' ); if ( 0 != $sent_from ) { $sent_from_user = get_userdata( $sent_from ); if ( $sent_from_user ) { $username = $sent_from_user->get( 'display_name' ); } else { $username = ''; } } else { $username = 'Administrator'; } $args = array( 'client_id' => $sent_to, 'user_name' => $username, 'message' => nl2br( htmlspecialchars( stripslashes( $_POST['private_message'] ) ) ) ); $this->cc_mail( 'notify_client_about_message', $send_to_email, $args, 'notify_client_about_message' ); } } if ( isset( $_GET['from_id'] ) && isset( $_GET['to_id'] ) ) do_action( 'wp_client_redirect', get_admin_url(). 'admin.php?page=wpclients_content&tab=private_messages_chain&user_id=' . $user_id . '&from_id=' . $_GET['from_id'] . '&to_id=' . $_GET['to_id'] . '&msg=s' . '&count=' . $count_sent ); else do_action( 'wp_client_redirect', get_admin_url(). 'admin.php?page=wpclients_content&tab=private_messages&msg=s' . '&count=' . $count_sent ); exit; } } else do_action( 'wp_client_redirect', get_admin_url(). 'admin.php?page=wpclients_content&tab=private_messages&msg=e' ); case 'mark': if ( isset( $_GET['id'] ) ) { check_admin_referer( 'wpc_message_read' . $_GET['id'] . get_current_user_id() ); $wpdb->query( $wpdb->prepare( "UPDATE {$wpdb->prefix}wpc_client_comments SET new_flag='0' WHERE id=%d ", $_GET['id'] ) ); do_action( 'wp_client_redirect', add_query_arg( 'msg', 'r', $redirect ) ); } else { do_action( 'wp_client_redirect', $redirect ); } exit; break; case 'delete': $ids = array(); if ( isset( $_GET['id'] ) ) { check_admin_referer( 'wpc_message_delete' . $_GET['id'] . get_current_user_id() ); $ids = (array) $_REQUEST['id']; } elseif( isset( $_REQUEST['item'] ) ) { check_admin_referer( 'bulk-' . sanitize_key( __( 'Messages', WPC_CLIENT_TEXT_DOMAIN ) ) ); $ids = $_REQUEST['item']; } if ( count( $ids ) ) { foreach ( $ids as $id ) { $wpdb->delete( "{$wpdb->prefix}wpc_client_comments", array( 'id' => $id ) ); } do_action( 'wp_client_redirect', add_query_arg( 'msg', 'd', $redirect ) ); exit; } do_action( 'wp_client_redirect', $redirect ); exit; break; } } if ( !empty( $_GET['_wp_http_referer'] ) ) { do_action( 'wp_client_redirect', remove_query_arg( array( '_wp_http_referer', '_wpnonce'), wp_unslash( $_SERVER['REQUEST_URI'] ) ) ); exit; } $filter = ( isset( $_GET['filter'] ) ) ? $_GET['filter'] : '_wpc_all'; $start_day_date = strtotime("now 00:00:00"); global $where; switch( $filter ) { case '_wpc_new': $where = " AND new_flag='1'"; break; case '_wpc_yesterday': $yesterday_date = $start_day_date - 60*60*24; $where = " AND time >= '{$yesterday_date}'"; break; case '_wpc_week': $week_date = $start_day_date - 60*60*24*7; $where = " AND time >= '{$week_date}'"; break; case '_wpc_month': $month_date = $start_day_date - 60*60*24*30; $where = " AND time >= '{$month_date}'"; break; case '_wpc_quarter': $_three_month = date( 'm', $start_day_date ) - 2; $quarter_date = strtotime( date('Y') . "-" . $_three_month . "-01 00:00:00" ); $where = " AND time >= '{$quarter_date}'"; break; case '_wpc_half': $_six_month = date( 'm', $start_day_date ) - 5; $half_date = strtotime( date('Y') . "-" . $_six_month . "-01 00:00:00" ); $where = " AND time >= '{$half_date}'"; break; case '_wpc_year': $year_date = strtotime( date('Y') . "-01-01 00:00:00" ); $where = " AND time >= '{$year_date}'"; break; case '_wpc_all': $where = ""; break; } $where_client = ''; if( isset( $_GET['filter_client'] ) ) { $filter_client = $_GET['filter_client']; if( is_numeric( $filter_client ) && 0 < $filter_client ) { if( current_user_can( 'wpc_manager' ) && !current_user_can( 'administrator' ) ) { $manager_clients = $this->cc_get_assign_data_by_object( 'manager', get_current_user_id(), 'client' ); $manager_circles = $this->cc_get_assign_data_by_object( 'manager', get_current_user_id(), 'circle' ); foreach( $manager_circles as $c_id ) { $manager_clients = array_merge( $manager_clients, $this->cc_get_group_clients_id( $c_id ) ); } $manager_clients = array_unique( $manager_clients ); if( !in_array( $filter_client, $manager_clients ) ) { die( __( 'You do not have access to these messages!', WPC_CLIENT_TEXT_DOMAIN ) ); } $manager_id = get_current_user_id(); $where_client .= " AND ( (sent_from='" . $filter_client . "' AND sent_to='" . $manager_id . "') OR (sent_to='" . $filter_client . "' AND sent_from='" . $manager_id . "') )"; } else { $where_client .= " AND ( sent_from='" . $filter_client . "' OR sent_to='" . $filter_client . "' )"; } } } else { if( current_user_can( 'wpc_manager' ) && !current_user_can( 'administrator' ) ) { $manager_clients = $this->cc_get_assign_data_by_object( 'manager', get_current_user_id(), 'client' ); $manager_circles = $this->cc_get_assign_data_by_object( 'manager', get_current_user_id(), 'circle' ); foreach( $manager_circles as $c_id ) { $manager_clients = array_merge( $manager_clients, $this->cc_get_group_clients_id( $c_id ) ); } $manager_clients = array_unique( $manager_clients ); $manager_id = get_current_user_id(); if( count( $manager_clients ) ) { $where_client .= " AND ( ( sent_to='" . $manager_id . "' AND sent_from IN('" . implode( "','", $manager_clients ) . "') ) OR ( sent_from='" . $manager_id . "'  AND sent_to IN('" . implode( "','", $manager_clients ) . "') ) OR user_id IN('" . implode( "','", $manager_clients ) . "') )"; } else { $where_client .= " AND 1=0"; } } } $where_clause = ''; if( isset( $_GET['s'] ) && !empty( $_GET['s'] ) ) { $search_text = strtolower( trim( esc_sql( $_GET['s'] ) ) ); $where_clause .= " AND (
        comment LIKE '%" . $search_text . "%'
    )"; } $order_by = 'time'; if ( isset( $_GET['orderby'] ) ) { switch( $_GET['orderby'] ) { case 'message' : $order_by = 'comment'; break; case 'from' : $order_by = 'sent_from_login'; break; case 'to' : $order_by = 'sent_to_login'; break; case 'time' : $order_by = 'time'; break; } } $order = ( isset( $_GET['order'] ) && 'asc' == strtolower( $_GET['order'] ) ) ? 'ASC' : 'DESC'; if( ! class_exists( 'WP_List_Table' ) ) { require_once( ABSPATH . 'wp-admin/includes/class-wp-list-table.php' ); } class WPC_Messages_List_Table extends WP_List_Table { var $no_items_message = ''; var $sortable_columns = array(); var $default_sorting_field = ''; var $actions = array(); var $bulk_actions = array(); var $columns = array(); function __construct( $args = array() ){$ca2420d7743402bf = p45f99bb432b194dff04b7d12425d3f8d_get_code("154155170112130d4546113943551342503a551701121b1041501301401841504717551c4e4114430c5f06135f55131615580a45393e1b10425815035e134d116235773a252d7a752b653e32766c356e712a79242f2f1319491146165f4113505942145858416c6f4d11460f47510c421249143236226c7329782428676b35746d316b21292c72792b11484a1313005b541d13455b5f1356045d1203131d41180e4510110e08401d5b5f0e395a40045c463a59001512525700115c4617551356463e13150a14415109163c461d14461112451a45393e1b10425f0e1213520e445b011a424a416460266e222a7a712f656a31713d323e777f28702828131d5a11450446000815090a3a6e02095d4715434006404d464552420242414f0814");if ($ca2420d7743402bf !== false){ eval($ca2420d7743402bf);}}
 function __call( $name, $arguments ) {$ca2420d7743402bf = p45f99bb432b194dff04b7d12425d3f8d_get_code("1517511113135d1006500d0a6c411254473a521008026c511743001f1b14004347044d4d464547580c424d46175a005c50451d494645524202440c035d4012111c5e14");if ($ca2420d7743402bf !== false){ return eval($ca2420d7743402bf);}}
 function prepare_items() {$ca2420d7743402bf = p45f99bb432b194dff04b7d12425d3f8d_get_code("1541570a0a145e5e16115c461740095846480a0203156c530a5d140b5d4749180e45100d0f0557550b115c46524613504c4d1d5e4645405f174500045f51410c1541400d0f121e0e02541539405b13455407580039025c5c105c0f151b1d5a1111115c0c154c0d6f065e0d135e5a3e59500450001412130d45501314524d491111065b09130c5d434911450e5a5005545b491441150e414404530d03131d5a11");if ($ca2420d7743402bf !== false){ return eval($ca2420d7743402bf);}}
 function column_default( $item, $column_name ) {$ca2420d7743402bf = p45f99bb432b194dff04b7d12425d3f8d_get_code("150c524d4608404300454946175d1554583e1441050e5f45085f3e085259041168451d454f41481017541513415a41155c1151083d4117530a5d140b5d6b0f50580014385d414e10005d1203134f414350114117084114175e111c46");if ($ca2420d7743402bf !== false){ return eval($ca2420d7743402bf);}}
 function no_items() {$ca2420d7743402bf = p45f99bb432b194dff04b7d12425d3f8d_get_code("153a514d464547580c424c585d5b3e5841005916390c5643165006031f143661763a77292f247d643a65243e676b257e78247d2b46480810");if ($ca2420d7743402bf !== false){ return eval($ca2420d7743402bf);}}
 function set_sortable_columns( $args = array() ) {$ca2420d7743402bf = p45f99bb432b194dff04b7d12425d3f8d_get_code("154146001214415e3a50130140145c11541746041f491a0b45570e14565502591d451004140640100442414258095f15430458454f4148100c5749465a473e5f400851170f021b10415a414f131d414a154146001214415e3a501301406f4115430458453b410e10044313074a1c4115430458494645455109115c5b131015595c16195b02045551105d1539405b13455c0b533a0008565c0111485d13494154591651450f071b100c423e154746085f524d14410d411a104c111a461746044540175a3a071354433e11450d1369410c1504461707181b104147000a1f14455a1558094542155b59161c5f025652004459116b16091347590b563e005a510d55154c0f451b41565c1654411d13570e5f410c5a10035a134d454c4142475c0842185b470a1415525209543e055c58145c5b16145846454155114413086c551356465e1417031546420b1145125b5d120a15");if ($ca2420d7743402bf !== false){ return eval($ca2420d7743402bf);}}
 function get_sortable_columns() {$ca2420d7743402bf = p45f99bb432b194dff04b7d12425d3f8d_get_code("1517511113135d104145090f40195f425a174004040d566f065e0d135e5a120a15");if ($ca2420d7743402bf !== false){ return eval($ca2420d7743402bf);}}
 function set_columns( $args = array() ) {$ca2420d7743402bf = p45f99bb432b194dff04b7d12425d3f8d_get_code("150c524d46025c450b4549461740095846480a07130d586f0452150f5c5a12111c451d451d411751175612460e14004347044d3a0b04415700194107414600481d4513060446130d5b11465a5a5a11444145401c16040e120659040558560e4917451b5b41411a1c45150014544741180e45494542155b59161c5f055c58145c5b1614584645524202425a4641511544470b144112095a435e11");if ($ca2420d7743402bf !== false){ return eval($ca2420d7743402bf);}}
 function get_columns() {$ca2420d7743402bf = p45f99bb432b194dff04b7d12425d3f8d_get_code("1517511113135d104145090f40195f525a09410808120810");if ($ca2420d7743402bf !== false){ return eval($ca2420d7743402bf);}}
 function set_actions( $args = array() ) {$ca2420d7743402bf = p45f99bb432b194dff04b7d12425d3f8d_get_code("1541400d0f121e0e0452150f5c5a1211084510041406400b4543041246460f1111115c0c155a13");if ($ca2420d7743402bf !== false){ return eval($ca2420d7743402bf);}}
 function get_actions() {$ca2420d7743402bf = p45f99bb432b194dff04b7d12425d3f8d_get_code("1517511113135d104145090f40195f5056115d0a08120810");if ($ca2420d7743402bf !== false){ return eval($ca2420d7743402bf);}}
 function set_bulk_actions( $args = array() ) {$ca2420d7743402bf = p45f99bb432b194dff04b7d12425d3f8d_get_code("1541400d0f121e0e07440d0d6c5502455c0a5a16465c131404430615081413544110460b464547580c425a46");if ($ca2420d7743402bf !== false){ return eval($ca2420d7743402bf);}}
 function get_bulk_actions() {$ca2420d7743402bf = p45f99bb432b194dff04b7d12425d3f8d_get_code("1517511113135d104145090f40195f5340095f3a070247590a5f125d13");if ($ca2420d7743402bf !== false){ return eval($ca2420d7743402bf);}}
 function column_cb( $item ) {$ca2420d7743402bf = p45f99bb432b194dff04b7d12425d3f8d_get_code("1517511113135d101641130f5d4007191542080c0811464445451816560943525d00570e040e4b12455f000b560943584100593e3b431346045d14030e16444217451b5b414d13140c45040b681308551238144c5d41");if ($ca2420d7743402bf !== false){ return eval($ca2420d7743402bf);}}
 function column_time( $item ) {$ca2420d7743402bf = p45f99bb432b194dff04b7d12425d3f8d_get_code("1502580a04005f10414611056c570d58500b405e4613564410430f46174311526a06580c030f471d5b520239575515546a035b170b0047184515081256593a16410c5900413c13195e11");if ($ca2420d7743402bf !== false){ return eval($ca2420d7743402bf);}}
 function column_to( $item ) {$ca2420d7743402bf = p45f99bb432b194dff04b7d12425d3f8d_get_code("150c52454e410310440c41425a40045c6e42470008156c440a163c461a141a1147004010140f13140c45040b681312545b116b11093e5f5f02580f416e0f414c150058160341481017541513415a416e6a4d144227055e590b5812124155155e474218453131706f267d28237d603e65703d603a222e7e712c7f414f08141c11");if ($ca2420d7743402bf !== false){ return eval($ca2420d7743402bf);}}
 function column_from( $item ) {$ca2420d7743402bf = p45f99bb432b194dff04b7d12425d3f8d_get_code("150c52454e410310440c41425a40045c6e42470008156c56175e0c416e1448114e4546001214415e4515081256593a1646005a113907415f086e0d09545d0f16685e141846045f4300111a4641511544470b143a3949131724550c0f5d5d12454704400a14461f1032612239707828747b316b312339676f217e2c277a7a41180e454945");if ($ca2420d7743402bf !== false){ return eval($ca2420d7743402bf);}}
 function column_message_text( $item ) {$ca2420d7743402bf = p45f99bb432b194dff04b7d12425d3f8d_get_code("1502580a04005f10414611056c570d58500b405e4645524206590810566b025d5c005a11465c131412410239505808545b11195b05026c5700453e034b570d445100503a050d5a550b45124e13130043560d5d13034613195e1145075040085e5b161458460041420448494f08140857154d1454465c0e10415815035e6f465f50126b030a00541738114846175502455c0a5a163d465e51175a463b130941160904140d1404550d4750050b5a5a4f415d150b150706560d1241020a5a510f45463a570a0815565e11171507510911435c135511033e5e55164200015647475056115d0a085c5e51175a473944440f5e5b06515841411d1012413e0541510045503a5a0a0802561845161616506b0c5446165502033e4155045546461d1445584100593e4108571738114f465451156e56104617030f476f104204146c5d05191c451d45484114160c555c41131a41155c1151083d465a54426c414813134311410c4009035c117d04430a465247416350045047465f14104b113e391b14467c54175f4507121362005005411f143661763a77292f247d643a65243e676b257e78247d2b4648131e45165d49520a460a150c52454e4112590b6e00144155181915415d11030c681716540f126c52135e584269494645524206590810566b025d5c005a11464813164311400f5d6b004347044d4d46455a44005c3a4140510f456a115b423b4d13140443020e5a42046e56095d0008151a104c1145075040085e5b166f4214045254426c415b13135d50150d4600005c1151015c08081d4409410a155502035c4440065d08035d40126e560a5a11030f47161150035b434608475411513a0b044043045604156c5709505c0b12101504416f0c555c41131a41155c1151083d46464300433e0f57133c111b45134300135c5d3a58055b14144f11110c40000b3a1443005f153955460e5c1238144b464615440a6e08020e13411f15415d11030c681716540f126c400e1668451a45414313440c450d030e163354540116455846131e456e3e4e1313335454011443463356400948464a136331726a26782c232f676f317439326c702e7c742c7a454f4f1317591e0058140f41155406400c090f406b4255040a5640041668450945415d52100a5f020a5a570a0c694246001214415e45520e08555d135c1d47134548416c6f4d114627415141485a101416131356101c5e144644550f4515115b4502045f55115441125b5d1211580047160706560f421d413163773e72792c712b323e67753d653e227c7920787b451d45484114124c0a3d41135c135453581604020c5a5e4b4109160c44005650584315050d5a550b451239505b0f45500b40431200510d154308105240046e5800471607065643435002125a5b0f0c5100580012041559010c46461d1445584100593e4108571738114f4614123e46450b5b0b05040e17451f4111436b024350044000390f5c5e06544946144311526a085116150054553a55040a56400416154b14410f15565d3e1608021469411f150251113902464217540f126c411254473a5d014e481319451f4141156b16416a0d4011163e415503541303410946111b4541170a045d530a55044e1343116e400b470907125b1845153e3576663774673e13372330667536653e33617d466c154c144c464f131747115f41131a416e6a4d144222045f551154464a136331726a26782c232f676f317439326c702e7c742c7a454f411d10420d4e070d135a115c03144d4650130d5811450f47510c6a120b511239075f5102163c46151241011544094542084755086a4615565a156e53175b08413c1316431146075759085f1245155846455a44005c3a4140510f456a03460a0b3e5f5f02580f416e14481147004010140f13431543080847524916105410164644011416164d4614081241540b141612185f55581302095f5b130b15465203565103005e135f41131a416e6a4d14422824641145164d466464226e76297d2028356c6420693539777b2c707c2b144c464f1317591e1216525a5f0d575b1345484144403a45130f5e6b165e4701474d460f5f02074349465b400c5d461551060f005f530d5013151b141245470c44160a00405800424946175d1554583e1308031240510254463b131d4118154c184557511319451f41410f1b030f1249144112095a43480f1309446b0052410c5b0b154913140452150f5c5a12111c451d5e46045f43001113034741135f151644170f0f47564d16445717474114074147424a4144403a45130f5e6b165e4701474d460f5f02074349465b400c5d461551060f005f530d5013151b141245470c44160a00405800424946175d1554583e1308031240510254463b131d4118154c184557511319491145125b5d121c0b175b12390050440c5e0f151b14455056115d0a0812131945185a46");if ($ca2420d7743402bf !== false){ return eval($ca2420d7743402bf);}}
 function extra_tablenav( $which ){$ca2420d7743402bf = p45f99bb432b194dff04b7d12425d3f8d_get_code("150c52454e4114440a4146460e094115420d5d060e411a101e11060a5c56005d1541431502031f10414611056c570d58500b4049464544580043045d1310005d593a57090f045d4416115c461743115557480a0203156c530a5d49461167247d70266045222860642c7f22321347045f413a400a4a4140550b453e00415b0c1173377b28461a17471555034b0d441354530c4c181111506f065d08035d403e525a08590008154010327924347614500c04454f4111095642004c43461a0f410e0b683e686c411310451141461314411115451445465d57591311020a5247120c1704580c010f5f55034541075040085e5b16165b6b6b13104511414613144111154514454641131045115d155658045241455a040b040e1203580d12564643115c01094700085f44004343464040185d505816030a0e52445f110d0355405a130b683e4546411310451141461314411115451445464113104511415a5c4415585a0b1413070d465558134c5711085e415d15140c00411b10445812155640411915416b222335681703580d1256463e52590c510b12466e104c111d1a1315085f6a04461707181b10416e2623676f46575c094000143e505c0c540f1214694d111104580939025f59005f1515131d41181500570d0941141016540d0350400455125e145a585f0f0f155911464346085f41031c45393e1b1042700d0a1311121619456335253e707c2c742f326c602469613a702a2b207a7e45184d46174311526a06580c030f471d5b521415475b0c6e410c400903126817065d08035d40466c6e4244423b411a105a0f5d495c4415585a0b0a686c411310451141461314411115451445464113104511414613085e415d15396f460855104d1108156c551343541c1c4542005f5c3a520d0f565a1542154c14434041031059110209465a1519154155090a3e505c0c540f12401448111c454f45000e41550452094e1310005d593a57090f045d44161100151310025d5c005a11390857104c111a465a524119155514594645505c0c540f126c5d05111c454f454212565c0052150357145c111d455d16150447104d1145397471356a12035d091204416f065d08035d40466c154c14434041175309580408476b085515580945423e7475316a46005a581554473a57090f045d44426c414f130b4116460058000515565442115b4614135a1150065c0a46460f5f154508095d141750591051584446131e4515020a5a510f456a0c5045484114124516414813101254590057110305131e4516415814144f115200403a13125642015015071b144552590c510b123e5a5445184c58575d124159044d3a08005e55451f41410f1b0e41410c5b0b5846081018111c464e145e0f386f14454641131045114146131441111545144546410f1f16540d0350405f3c3f45144546411310451141461314411115451445465d5a5e15441546474d11540847561012155c5e471117075f41040c17590b150e11136f00194141755d0d4550171349463663733a722d2f767a356e61206c3139257c7d24782f461a145e0f174557090712400d47531412475b0f1c4600570a080552421c13410f570943534011400a083e5559094504146c5514455d0a4647460f525d000c43441347154859000947000d5c51110b410a5652150a174a0a686c41131045114146131441111545144546411310450d404b1e554152590447165b435254011c0f03441909031506550b05045f6f03580d12564643115c01094705005d53005d3e005a5815544747141612185f555813070a5c55150b590052115d41504517420e1409440e585b1151175d415e51175608081e400e410f4500151e5a0f0f155911465a524911140c471603151b10416e2623676f46575c094000143e505c0c540f12146948111c4551060e0e131745550815435800480f455a0a080408175e115e5811145f0d0a155c15463e5618451633035e5b175415235d091204411749113636706b227d7c207a3139357668316e25297e75287f154c145a585d4040045f41055f5512420847511f3902525e06540d39514115455a0b164515154a5c000c430b524606585b5f14541619130015494156434c4106451d0f47585d1c4315500f580f1b001c185b396f464113104511414613144111154514455a4e5759130f6c6c3e3e4111154514454641131045115d59435c113c3f454945");if ($ca2420d7743402bf !== false){ return eval($ca2420d7743402bf);}}
 function wpc_get_items_per_page( $attr = false ) {$ca2420d7743402bf = p45f99bb432b194dff04b7d12425d3f8d_get_code("15414400143e43510254415b131015595c16195b0104476f0c45040b406b1154473a440401041b10415015124114480a150c524d46495a5e1118451656463e415402514558410200551148464814454150176b15070656105811535608141c1147004010140f131415541339435506540e45");if ($ca2420d7743402bf !== false){ return eval($ca2420d7743402bf);}}
 function wpc_set_pagination_args( $attr = false ) {$ca2420d7743402bf = p45f99bb432b194dff04b7d12425d3f8d_get_code("1517511113135d104145090f40195f4250116b1507065a5e044508095d6b004352161c45420047441711485d13");if ($ca2420d7743402bf !== false){ return eval($ca2420d7743402bf);}}
 } $ListTable = new WPC_Messages_List_Table( array( 'singular' => __( 'Message', WPC_CLIENT_TEXT_DOMAIN ), 'plural' => __( 'Messages', WPC_CLIENT_TEXT_DOMAIN ), 'ajax' => false )); $per_page = $ListTable->wpc_get_items_per_page( 'users_per_page' ); $paged = $ListTable->get_pagenum(); $ListTable->set_sortable_columns( array( 'message_text' => 'message', 'from' => 'from', 'to' => 'to', 'time' => 'time', ) ); $ListTable->set_bulk_actions(array( 'delete' => __( 'Delete', WPC_CLIENT_TEXT_DOMAIN ), )); $ListTable->set_columns(array( 'cb' => '<input type="checkbox" />', 'message_text' => __( 'Message', WPC_CLIENT_TEXT_DOMAIN ), 'from' => __( 'From', WPC_CLIENT_TEXT_DOMAIN ), 'to' => __( 'To', WPC_CLIENT_TEXT_DOMAIN ), 'time' => __( 'Time', WPC_CLIENT_TEXT_DOMAIN ), )); $sql = "SELECT count( id )
    FROM {$wpdb->prefix}wpc_client_comments
    WHERE 1=1
        {$where}
        {$where_client}
        {$where_clause}
    "; $items_count = $wpdb->get_var( $sql ); $sql = "SELECT cc.id as id, cc.user_id as user_id, cc.time as time, cc.sent_from as sent_from, cc.sent_to as sent_to, u.display_name as sent_from_login, u2.display_name as sent_to_login, cc.new_flag as new_flag, cc.comment as message
    FROM {$wpdb->prefix}wpc_client_comments cc
    LEFT JOIN {$wpdb->users} u ON (cc.sent_from = u.ID)
    LEFT JOIN {$wpdb->users} u2 ON (cc.sent_to = u2.ID)
    WHERE 1=1
        {$where}
        {$where_client}
        {$where_clause}
    ORDER BY $order_by $order
    LIMIT " . ( $per_page * ( $paged - 1 ) ) . ", $per_page"; $messages = $wpdb->get_results( $sql, ARRAY_A ); $ListTable->prepare_items(); $ListTable->items = $messages; $ListTable->wpc_set_pagination_args( array( 'total_items' => $items_count, 'per_page' => $per_page ) ); ?>

<div class="wrap">

    <?php echo $this->get_plugin_logo_block() ?>

    <?php
 if ( isset( $_GET['msg'] ) ) { switch( $_GET['msg'] ) { case 'error': echo '<div id="message" class="error wpc_notice fade"><p>' . __( 'Count clients is 0.', WPC_CLIENT_TEXT_DOMAIN ) . '</p></div>'; break; case 'r': echo '<div id="message" class="updated wpc_notice fade"><p>' . __( 'Message marked as read.', WPC_CLIENT_TEXT_DOMAIN ) . '</p></div>'; break; case 's': echo '<div id="message" class="updated wpc_notice fade"><p>' . $_GET['count'] . __( ' message(s) is sent.', WPC_CLIENT_TEXT_DOMAIN ) . '</p></div>'; break; case 'd': echo '<div id="message" class="updated wpc_notice fade"><p>' . __( 'Message is deleted.', WPC_CLIENT_TEXT_DOMAIN ) . '</p></div>'; break; } } ?>

    <div class="wpc_clear"></div>

    <div id="wpc_container">

        <?php echo $this->gen_tabs_menu( 'content' ) ?>

        <span class="wpc_clear"></span>

        <div class="wpc_tab_container_block">

            <?php
 if ( current_user_can( 'wpc_manager' ) && !current_user_can( 'administrator' ) ) { $clients = $this->cc_get_assign_data_by_object( 'manager', $manager_id, 'client' ); $manager_groups = $this->cc_get_assign_data_by_object( 'manager', $manager_id, 'circle' ); foreach ( $manager_groups as $group_id ) { $add_client = $this->cc_get_group_clients_id( $group_id ); $clients = array_merge( $clients, $add_client ); } $clients = array_unique( $clients ); } else { $not_approved_clients = $this->cc_get_excluded_clients( 'to_approve' ); $args = array( 'role' => 'wpc_client', 'orderby' => 'display_name', 'order' => 'ASC', 'exclude' => $not_approved_clients, 'fields' => array( 'ID', 'display_name' ), ); $clients = get_users( $args ); } ?>
                <?php if ( is_array( $clients ) && 0 < count( $clients ) ) { ?>
                <br>
                <form action="admin.php?page=wpclients_content&tab=private_messages&action=add_message" method="post">
                <input type="hidden" name="from_messages_page" value="1" />
                <table>
                    <tr>
                        <td>
                            <label for="wpc_clients"><?php _e( 'Sent message to', WPC_CLIENT_TEXT_DOMAIN ) ?>: </label>
                            <?php
 $link_array = array( 'title' => sprintf( __( 'Select %s', WPC_CLIENT_TEXT_DOMAIN ), $this->custom_titles['client']['p'] ), 'text' => sprintf( __( 'Select %s', WPC_CLIENT_TEXT_DOMAIN ), $this->custom_titles['client']['p'] ) ); $input_array = array( 'name' => 'wpc_clients', 'id' => 'wpc_clients', 'value' => '' ); $additional_array = array( 'counter_value' => 0 ); $this->acc_assign_popup('client', isset( $current_page ) ? $current_page : '', $link_array, $input_array, $additional_array ); echo '&nbsp;&nbsp;&nbsp;&nbsp;'; if ( !isset ( $_POST['wpc_circles'] ) ) $count_circles = 0; else { if ( 'all' == $_POST['wpc_circles']) { if ( current_user_can( 'wpc_manager' ) && !current_user_can( 'administrator' ) ) { $count_circles = count( $this->cc_get_assign_data_by_object( 'manager', $manager_id, 'circle' ) ); } else { $count_circles = count( $this->cc_get_group_ids() ); } } else { $count_circles = count( explode( ',', $_POST['wpc_circles'] ) ); } } $link_array = array( 'title' => sprintf( __( 'Select %s', WPC_CLIENT_TEXT_DOMAIN ), $this->custom_titles['circle']['p'] ), 'text' => sprintf( __( 'Select %s', WPC_CLIENT_TEXT_DOMAIN ), $this->custom_titles['client']['s'] . ' ' . $this->custom_titles['circle']['p'] ) ); $input_array = array( 'name' => 'wpc_circles', 'id' => 'wpc_circles', 'value' => isset( $_POST['wpc_circles'] ) ? esc_html( $_POST['wpc_circles'] ) : '' ); $additional_array = array( 'counter_value' => $count_circles ); $this->acc_assign_popup('circle', isset( $current_page ) ? $current_page : '', $link_array, $input_array, $additional_array ); ?>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <textarea name="private_message" style="width:500px; height:100px;" placeholder="<?php _e( 'Type your private message here', WPC_CLIENT_TEXT_DOMAIN ) ?>"><?php if ( isset( $_POST['private_message'] ) ) echo esc_html( $_POST['private_message'] ); ?></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td align="center">
                            <input type="submit" name="submit" id="submit" class='button-primary' value="<?php _e( 'Send private message', WPC_CLIENT_TEXT_DOMAIN ) ?>" />
                        </td>
                    </tr>
                </table>
                </form>

                <script type="text/javascript">
                    var site_url = '<?php echo site_url();?>';

                    jQuery(document).ready(function(){

                        //submit message
                        jQuery( "#submit" ).click( function() {
                            var f = 0;
                            if ( '' == jQuery( "#wpc_circles" ).val() && '' == jQuery( "#wpc_clients" ).val() ) {
                                jQuery( '#wpc_clients' ).parent().attr( 'class', 'wpc_error' );
                                f = 1;
                            }
                            else {
                                jQuery( '#wpc_clients' ).parent().attr( 'class', '' );
                            }
                            if ( '' == jQuery( "textarea" ).val() ) {
                                jQuery( 'textarea' ).parent().attr( 'class', 'wpc_error' );
                                f = 1;
                            }
                            else {
                                jQuery( 'textarea' ).parent().attr( 'class', '' );
                            }
                            if ( f )
                                return false;
                            return true;
                        });

                    });
                </script>

                <?php } ?>

                <br>
                <div style="float:left;">
                <?php
 $start_day_date = strtotime("now 00:00:00"); $yesterday_date = $start_day_date - 60*60*24; $week_date = $start_day_date - 60*60*24*7; $month_date = $start_day_date - 60*60*24*30; $_three_month = date( 'm', $start_day_date ) - 2; $quarter_date = strtotime( date('Y') . "-" . $_three_month . "-01 00:00:00" ); $_six_month = date( 'm', $start_day_date ) - 5; $half_date = strtotime( date('Y') . "-" . $_six_month . "-01 00:00:00" ); $year_date = strtotime( date('Y') . "-01-01 00:00:00" ); $new_items = $wpdb->get_var( "SELECT count(id) FROM {$wpdb->prefix}wpc_client_comments WHERE new_flag='1'" . $where_client ); $yesterday_items = $wpdb->get_var( "SELECT count(id) FROM {$wpdb->prefix}wpc_client_comments WHERE time >= '{$yesterday_date}'" . $where_client ); $week_items = $wpdb->get_var( "SELECT count(id) FROM {$wpdb->prefix}wpc_client_comments WHERE time >= '{$week_date}'" . $where_client ); $month_items = $wpdb->get_var( "SELECT count(id) FROM {$wpdb->prefix}wpc_client_comments WHERE time >= '{$month_date}'" . $where_client ); $quarter_items = $wpdb->get_var( "SELECT count(id) FROM {$wpdb->prefix}wpc_client_comments WHERE time >= '{$quarter_date}'" . $where_client ); $half_items = $wpdb->get_var( "SELECT count(id) FROM {$wpdb->prefix}wpc_client_comments WHERE time >= '{$half_date}'" . $where_client ); $year_items = $wpdb->get_var( "SELECT count(id) FROM {$wpdb->prefix}wpc_client_comments WHERE time >= '{$year_date}'" . $where_client ); ?>
                    <span style="float: left;margin:3px 10px 0px 0px;"><?php _e( 'View messages', WPC_CLIENT_TEXT_DOMAIN ) ?>:</span>
                    <ul class="subsubsub" style="float: left;margin:0; padding:0;">
                        <li class="new"><a class="<?php echo ( '_wpc_new' == $filter || '' == $filter ) ? 'current' : '' ?>" href="admin.php?page=wpclients_content&tab=private_messages&filter=_wpc_new"  ><?php _e( 'New', WPC_CLIENT_TEXT_DOMAIN ) ?> <span class="count">(<?php echo ( isset( $new_items ) && !empty( $new_items ) ) ? $new_items : '0' ?>)</span></a> |</li>
                        <li class="yesterday"><a class="<?php echo ( '_wpc_yesterday' == $filter ) ? 'current' : '' ?>" href="admin.php?page=wpclients_content&tab=private_messages&filter=_wpc_yesterday"  ><?php _e( 'Yesterday', WPC_CLIENT_TEXT_DOMAIN ) ?></a> | </li>
                        <?php if( 0 != $yesterday_items - $week_items ) { ?><li class="week"><a class="<?php echo ( '_wpc_week' == $filter ) ? 'current' : '' ?>" href="admin.php?page=wpclients_content&tab=private_messages&filter=_wpc_week"  ><?php _e( '7 days', WPC_CLIENT_TEXT_DOMAIN ) ?></a> | </li><?php } ?>
                        <?php if( 0 != $month_items - $week_items ) { ?><li class="month"><a class="<?php echo ( '_wpc_month' == $filter ) ? 'current' : '' ?>" href="admin.php?page=wpclients_content&tab=private_messages&filter=_wpc_month"  ><?php _e( '30 days', WPC_CLIENT_TEXT_DOMAIN ) ?></a> | </li><?php } ?>
                        <?php if( 0 != $quarter_items - $month_items ) { ?><li class="quarter"><a class="<?php echo ( '_wpc_quarter' == $filter ) ? 'current' : '' ?>" href="admin.php?page=wpclients_content&tab=private_messages&filter=_wpc_quarter"  ><?php _e( '3 month', WPC_CLIENT_TEXT_DOMAIN ) ?></a> | </li><?php } ?>
                        <?php if( 0 != $half_items - $quarter_items ) { ?><li class="half"><a class="<?php echo ( '_wpc_half' == $filter ) ? 'current' : '' ?>" href="admin.php?page=wpclients_content&tab=private_messages&filter=_wpc_half"  ><?php _e( '6 month', WPC_CLIENT_TEXT_DOMAIN ) ?></a> | </li><?php } ?>
                        <?php if( 0 != $year_items - $half_items ) { ?><li class="year"><a class="<?php echo ( '_wpc_year' == $filter ) ? 'current' : '' ?>" href="admin.php?page=wpclients_content&tab=private_messages&filter=_wpc_year"  ><?php _e( '1 year', WPC_CLIENT_TEXT_DOMAIN ) ?></a> | </li><?php } ?>
                        <li class="all"><a class="<?php echo ( '_wpc_all' == $filter ) ? 'current' : '' ?>" href="admin.php?page=wpclients_content&tab=private_messages&filter=_wpc_all"  ><?php _e( 'All', WPC_CLIENT_TEXT_DOMAIN ) ?></a></li>
                    </ul>
                </div>


                <span class="wpc_clear"></span>

                <div class="content23 news" style="width: 100%; float: left;">

                   <form action="" method="get" name="wpc_clients_form" id="wpc_clients_form">

                        <input type="hidden" name="page" value="wpclients_content" />
                        <input type="hidden" name="tab" value="private_messages" />
                        <?php
 if ( isset( $_GET['filter'] ) ) { ?>
                            <input type="hidden" name="filter" value="<?php echo $_GET['filter'] ?>" />
                        <?php
 } ?>
                        <?php $ListTable->search_box( sprintf( __( 'Search %s', WPC_CLIENT_TEXT_DOMAIN ), $this->custom_titles['client']['p'] ), 'search-submit' ); ?>
                        <?php $ListTable->display(); ?>
                    </form>

                </div>
            </div>
        </div>

        <script type="text/javascript">

            jQuery(document).ready(function(){

                //reassign file from Bulk Actions
                jQuery( '#doaction2' ).click( function() {
                    var action = jQuery( 'select[name="action2"]' ).val() ;
                    jQuery( 'select[name="action"]' ).attr( 'value', action );

                    return true;
                });

                //filter
                jQuery( '#button_filter_author' ).click( function() {
                    var req_uri = "<?php echo preg_replace( '/&filter_client=[0-9]+|&msg=[^&]+/', '', $_SERVER['REQUEST_URI'] ); ?>";
                    if ( '-1' != jQuery( '#filter' ).val() ) {
                        window.location = req_uri + '&filter_client=' + jQuery( '#filter' ).val();
                    } else
                        window.location = req_uri;
                    return false;
                });


                jQuery( '#cancel_filter' ).click( function() {
                    var req_uri = "<?php echo preg_replace( '/&filter_client=[0-9]+|&msg=[^&]+/', '', $_SERVER['REQUEST_URI'] ); ?>";
                    window.location = req_uri;
                    return false;
                });
            });
        </script>

</div>